<!DOCTYPE html>
<html lang="en">
<head>
  <title>Budget Breakdown: Cook County, IL</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;" />
  
  <link href="styles/master.css" rel="stylesheet" type="text/css" />
  
  <link href="images/favicon.ico" rel="shortcut icon" type="image/x-icon" />
  
  <script src="scripts/jquery.js" type="text/javascript"></script>
  <script src="scripts/highcharts.js" type="text/javascript"></script>
  <script src="scripts/jquery.dataTables.js" type="text/javascript"></script>
  <script src="scripts/dataTables.sorting.js" type="text/javascript"></script>
  <script type="text/javascript" src="http://www.google.com/jsapi"></script>
  <script src="scripts/jquery.formatCurrency-1.4.0.min.js" type="text/javascript"></script>
  <script src="scripts/jquery.address-1.4.min.js" type="text/javascript"></script>
  <script src="scripts/budget.fusiontables.js" type="text/javascript"></script>
  <script src="scripts/jquery.ga-event-tracker.js" type="text/javascript"></script>
  
  <script type="text/javascript">
  
  	
	$.address.change(function(event) {  
	    // do something depending on the event.value property, e.g.  
	    //alert('year: ' + $.address.parameter('year') + ', fund: ' + $.address.parameter('fund'));
        loadFor($.address.parameter('year'),$.address.parameter('fund'));
	});  
  
	var loadYear = 2011;
	var fundView = '';
  	var arraysLoaded = 0;
    function updateMainChart() {
   	  arraysLoaded++;
   	  if (arraysLoaded >= 2)
   	  {
   	  	var minValuesArray = $.grep(appropTotalArray.concat(expendTotalArray), function(val) { return val != null; });
	      // Highcharts
	      chart1 = new Highcharts.Chart({
	      chart: {
	        defaultSeriesType: "area",
	        renderTo: "timeline-chart"
	      },
	      credits: { enabled: false },
	      plotOptions: {
	        area: { fillOpacity: 0.25 },
	        series: {
	          lineWidth: 5,
	          point: {
              events: {
                click: function() {
                  var x = this.x,
                      selected = !this.selected,
                      index = this.series.index;
                  console.log(this)
                  this.select(selected, false);

                  $.each(this.series.chart.series, function(i, serie) {
                    if (serie.index !== index) {
                      $(serie.data).each(function(j, point){
                        if(x === point.x) {
                          point.select(selected, true);
                        }
                      });
                    }
                  });
				  var clickedYear = new Date(x).getFullYear();
				  
				  $.address.parameter('year',clickedYear)
                }
              }
            },
            pointInterval: 365 * 24 * 3600 * 1000,
	          pointStart: Date.UTC(1993, 1, 1),
	          shadow: false
	        }
	      },
	      series: [
	        {
	          color: "#264870",
	          data: appropTotalArray,
	          marker: {
	            radius: 6,
	            symbol: "circle"
	          },
	          name: "Budgeted"
	        }, {
	          color: "#7d9abb",
	          data: expendTotalArray,
	          marker: {
	            radius: 8,
	            symbol: "square"
	          },
	          name: "Spent"
	        }
	      ],
	      title: null,
	      tooltip: {
	        borderColor: "#000",
	        formatter: function() {
	          var s = "<strong>" + Highcharts.dateFormat("%Y", this.x) + "</strong>";
	          $.each(this.points, function(i, point) {
	            s += "<br /><span style=\"color: " + point.series.color + "\">" + point.series.name + ":</span> $" + Highcharts.numberFormat(point.y, 0);
	          });
	          return s;
	        },
	        shared: true
	      },
	      xAxis: {
	        dateTimeLabelFormats: { year: "%Y" },
	        gridLineColor: "#ddd",
	        gridLineWidth: 1,
	        type: "datetime"
	      },
	      yAxis: {
	        gridLineColor: "#ddd",
	        labels: {
	          formatter: function() {
	            if (this.value >= 1000000000)
	              return "$" + this.value / 1000000000 + "B";
	            else if (this.value >= 1000000)
	              return "$" + this.value / 1000000 + "M";
	            else
	              return "$" + this.value;
	          }
	        },
	        min: Math.min.apply( Math, minValuesArray ),
	        title: null
	      }
	  	});
  	}
    }
    
    function updateTable() {
      $('#breakdown').fadeOut('fast', function(){
        if (breakdownTable != null) breakdownTable.fnDestroy();
        
        $('#breakdown tbody').children().remove();
        $('#breakdown > tbody:last').append(breakdownData);
        
        var maxArray = new Array();
        $('.budgeted.num').each(function(){
          maxArray.push(parseInt($(this).html()));
        });
        $('.spent.num').each(function(){
          maxArray.push(parseInt($(this).html()));
        });
        
        var maxBudgeted = Math.max.apply( Math, maxArray );
        if (maxBudgeted > 0)
        {
          $('.budgeted.num').each(function(){
            $(this).siblings().children().children('.budgeted.outer').width((($(this).html()/maxBudgeted) * 100) + '%');
          });
          $('.spent.num').each(function(){
            $(this).siblings().children().children('.spent.inner').width((($(this).html()/maxBudgeted) * 100) + '%');
          });
        }
        $('.budgeted.num').formatCurrency();
        $('.spent.num').formatCurrency();
        
        $('#breakdown a').address(); //after adding the table rows, initialize the address plugin on all the links
        
        breakdownTable = $("#breakdown").dataTable({
          "aaSorting": [[1, "desc"]],
          "aoColumns": [
            null,
            { "sType": "currency" },
            { "sType": "currency" },
            { "bSortable": false }
          ],
          "bFilter": false,
          "bInfo": false,
          "bPaginate": false
        });
      }).fadeIn('fast');
    }
    
    function loadFor(year, fund) {
      var yearChanged = true;
      fundView = '';
      if (fund != null && fund != "")
      	fundView = fund.replace(/\++/g, ' ');
      
      if (year != null && year != ""){
        //alert('year: ' + year + ", loadYear: " + loadYear);
        if (loadYear+'' == year+''){
        	yearChanged = false;
        	//alert('year changed');
        	}
      	loadYear = year;
      }
      else
      	loadYear = 2011;
      	
      
      //alert('fundView: ' + fundView + ", loadYear: " + loadYear);	
      if (fundView != ""){
        //if (yearChanged){
        	getFundTotalArray(fundView, true, updateAppropTotal);
  			getFundTotalArray(fundView, false, updateExpendTotal);
  		//}
        getDepartmentsForFund(fundView, loadYear, getDataAsBudgetTable);
        $('#timeline h2').html(fundView + ' budget for ' + loadYear);
      }
      else{
      	//if (yearChanged){
      		getFundTotalArray('', true, updateAppropTotal);
  			getFundTotalArray('', false, updateExpendTotal);
  		//}
      	getAllFundsForYear(loadYear, getDataAsBudgetTable);
      	$('#timeline h2').html('Entire budget for ' + loadYear);
      }	
    }    
    
    $(function() {
      
      //loadFor($.address.parameter('year'),$.address.parameter('fund'));
    
	  $('#download-button').attr("href","http://www.google.com/fusiontables/DataSource?dsrcid=" + fusionTableId);
    });
  </script>
</head>
<body>

<div id="page">
  <div id="header">
    <div id="logo"><img alt="Budget Breakdown: Cook County, IL" src="images/logo.png" /></div>
    <div id="header-secondary">A project from <a href="http://www.fritchey.com">John Fritchey</a><br />Cook County Commissoner of the 12th District</div>
    <div class="clear"></div>
  </div>
  
  <div id="content">
    <div id="content-primary">
      <h1>Where's the money going?</h1>
      <p>Explore Cook County's budget over the years and learn how the money is being spent. <a href="/budget/?year=2011&fund=Public%20Safety%20Fund" rel="address:/budget/?year=2011&fund=Public%20Safety%20Fund">More about this project</a> &raquo;</p>
      
      <div id="timeline">
        <h2>2011</h2>
        <div id="timeline-chart"></div>
      </div>
      
      <table id="breakdown">
        <thead>
          <tr>
            <th><span>Fund</span></th>
            <th class="num"><span>Budgeted</span></th>
            <th class="num"><span>Spent</span></th>
            <th class="charts">Budgeted vs. spent</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
    
    <div id="content-secondary">
      <h2>About</h2>
      
      <div class="columns">
        <p>Every year your Cook County government budgets and spends more than $3 billion collected from the millions of people who live in and visit Chicagoland. Your County's budget impacts your life every day. All of its funding comes from you&mdash;your sales and property taxes, your purchase fees on gas, cigarettes and alcohol. All of its spending exists to support you, too&mdash;or at least it's supposed to. County funding drives the forest preserve district, the jail, public hospitals and clinics, the Cook County courts and dozens of other civic institutions designed to make our region prosperous, efficient and fair.</p>
        <p>The County Board and its President publish a budget every year that meticulously catalogues Cook County's spending, yet too many residents say they still don't understand what Cook County government is or what it does. They keep asking, "where exactly does our money go?"</p>
        <p>Cook County Commissioner John Fritchey created this budget transparency project to answer that question. We took County appropriations and expenditures by departmental account for every year from 1993 to the present, then we recruited a pair of enterprising Chicago-based web developers to visualize County spending in a way citizens can understand and engage with. The result is what you're seeing.</p>
        <p>This budget visualization tool is only a first step. We need your help. What questions do you have about County spending? What do you want to know about the County budget that this visualization isn't explaining to you? What do you think of our spending? What can we do to make Cook County government better?</p>
        <p>Connect with us on <a class="icon-facebook" href="http://www.facebook.com/John.Fritchey">Facebook</a>, <a class="icon-twitter" href="http://twitter.com/johnfritchey">Twitter</a>, or contact us.</p>
      </div>
    </div>
    
    <div id="content-tertiary">
      <a id="download-button" class="action" href="#">View &amp; download data</a>
      <h2>Explore the data</h2>
      
      <p>All the data for this project is freely available to download or explore on Google Fusion Tables.</p>
    </div>
  </div>
  
  <div id="footer">
    <ul class="share">
      <li><a href="http://www.facebook.com/share.php?u=http%3a%2f%2fwww.fritchey.com%2fbudget"><img alt="Facebook" src="images/facebook-lg.png" /> Share budget on <strong>Facebook</strong></a></li>
      <li><a href="http://twitter.com/share?text=Where's%20the%20money%20going%3F%20Explore%20Cook%20County's%20budget&amp;url=http%3a%2f%2fwww.fritchey.com%2fbudget"><img alt="Twitter" src="images/twitter-lg.png" /> Share budget on <strong>Twitter</strong></a></li>
    </ul>
    
    <div id="credit">Budget Breakdown developed and designed by <a href="http://www.derekeder.com">Derek Eder</a> and <a href="http://www.c82.net">Nick Rougeux</a></div>
  </div>
</div>

</body>
</html>